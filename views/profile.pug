doctype html
html(lang="en")
head
    meta(charset="utf-8")
    title='Profile - Pplware'
    meta(name="viewport",content="width=device-width, initial-scale=1")
    block styles
        link(href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css",rel="stylesheet")
        link(rel='stylesheet', href='https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css')
        style
            include ../assets/css/navbar.css
    block scripts
        script(src="https://code.jquery.com/jquery-3.2.1.min.js")
body(style="width:100%")
    div(class="navbar navbar-inverse nav")
        div(class="navbar-inner")
            div(class="container")
                a(class="btn btn-navbar",data-toggle="collapse",data-target=".nav-collapse")
                    span(class="icon-bar")
                    span(class="icon-bar")
                    span(class="icon-bar")
                a(class="brand",href="/") NewsSports
                div(class="nav-collapse collapse")
                    ul(class="nav")
                        li(class="divider-vertical")
                        li(style="width:90px;margin-left:-11px",class="divider-vertical")
                            a(href="/")
                                i(class="icon-home icon-white") 
                                p(style="padding-left:20px;margin-top:-20px;font-style:normal;") Home
                        if(user && user.admin == true)
                            li(style="width:120px;margin-left:-11px",class="divider-vertical")
                                a(href="/backoffice")
                                    i(class="fa fa-user-secret icon-white",style="font-style:normal;",aria-hidden="true")
                                    p(style="padding-left:20px;margin-right:10px;margin-top:-20px;font-style:normal;") BackOffice
                    div(class="pull-right")
                        ul(class="nav pull-right")
                            if(user)
                                li(class="dropdown")
                                    a(class="dropdown-open") Welcome, #{user.firstName+" "+user.lastName}
                                        b(class="caret")
                                    ul(class="dropdown-menu")
                                        li(style="margin-top: -5px;")
                                            a(href="/profile",style="height:23px")
                                                i(class="icon-cog")
                                                p(style="padding-left:18px;top:8px;position:absolute;font-style:normal;") Control Panel
                                        li(style="margin-bottom: -5px;")
                                            a(href="/help/support",style="height:23px")
                                                i(class="icon-envelope")
                                                p(style="padding-left:18px;top:-20px;position:relative;font-style:normal;") Contact Support
                                        li(class="divider")
                                        li(style="margin-top: -10px;margin-bottom: -5px;")
                                            a(href="/logout",style="height:23px")
                                                i(class="icon-off")
                                                p(style="padding-left:18px;top:-20px;position:relative;font-style:normal;") Logout
                            else
                                li(class="dropdown")
                                    a(href="/Login") Welcome, Guest
    
div(class="container", style="padding-top: 60px;")
    h1(class="page-header") Edit Profile
    div(class="row")
        div(class="col-md-4 col-sm-6 col-xs-12")
            div(style="position:relative;margin-left:40px")
                img(id="procpic",src=user.picurl || 'https://openclipart.org/download/247319/abstract-user-flat-3.svg', class="avatar img-circle img-thumbnail", alt="avatar", style="height:150px;width:150px;margin-left:190px")
    br
    form(action="/profile",class="form-horizontal", method="post", id="userprof")
        div(class="form-group")
        label(class="col-lg-3 control-label") Enter Url: 
        div(class="col-lg-8")
            input(type="text",class="text-center center-block well well-sm",style="margin-top:5px",name="picurl",value=user.picurl)
        br
        div(class="col-md-8 col-sm-6 col-xs-12 personal-info")
            h3 Personal info
            hr
            div(class="form-group")
                label(class="col-lg-3 control-label") First name: 
                div(class="col-lg-8")
                    input(class="form-control", value=user.firstName,name="firstName", type="text")
            div(class="form-group")
                label(class="col-lg-3 control-label") Last name: 
                div(class="col-lg-8")
                    input(class="form-control", value=user.lastName,name="lastName", type="text")
            div(class="form-group")
                label(class="col-lg-3 control-label") Email: 
                div(class="col-lg-8")
                    input(class="form-control", value=user.email,name="email", type="text")
            div(class="form-group")
                label(class="col-md-3 control-label") Username: 
                div(class="col-md-8")
                    input(class="form-control", value=user.username,name="usernm", type="text")
            div(class="form-group")
                label(class="col-md-3 control-label") Password: 
                div(class="col-md-8")
                    input(class="form-control", type="password",name="pass",id="pass",onkeyup="verificaPass()")
            div(class="form-group")
                label(class="col-md-3 control-label") Confirm password: 
                div(class="col-md-8")
                    input(class="form-control", type="password",name="confirmPass",id="confirmPass",onkeyup="verificaPass()",style="margin-bottom:5px;")
            label(style="display:none;margin-left:190px;margin-bottom:-10px;",id="confirmMessage") Message: 
            br
            div(class="form-group")
                label(class="col-md-3 control-label")
                div(class="col-md-8")
                    input(class="btn btn-primary", value="Save Changes", type="submit")
                    span &nbsp;&nbsp;&nbsp;
                    input(class="btn btn-default", value="Cancel", type="reset")
                    
script.
    var picurl = "";
    var firstName = "";
    var lastName = "";
    var email = "";
    var username = "";
    var password = "";

    /*********************************************************************************************/
    /*************************     Valores do Formulario a actualizar     ************************/
    /*********************************************************************************************/
    // Se os valores de um destes inputs mudarem vamos alterar o valor da variavel correspondente
    // para enviar apenas os dados que foram alterados no formulario.
    
    $("input[name='picurl']").on('change paste keyup',function(){
        // Vai guardar em picurl o valor da string introduzida no input picurl que esta a frente da
        // label Enter Url: 
        picurl = $("#userprof").find('input[name="picurl"]').val();
        $("#procpic").attr("src",picurl);
    });
    
    $("input[name='firstName']").on('change keyup',function(){
        // Vai guardar em firstName o valor da string introduzida no input firstName
        firstName = $("#userprof").find('input[name="firstName"]').val();
    });
    
    $("input[name='lastName']").on('change paste keyup',function(){
        // Vai guardar em lastName o valor da string introduzida no input lastName
        lastName = $("#userprof").find('input[name="lastName"]').val();
    });
    
    $("input[name='email']").on('change keyup',function(){
        // Vai guardar em email o valor da string introduzida no input email
        email = $("#userprof").find('input[name="email"]').val();
    });
    
    $("input[name='usernm']").on('change keyup',function(){
        // Vai guardar em username o valor da string introduzida no input usernm
        username = $("#userprof").find('input[name="usernm"]').val();
    });
    
    $("input[name='pass']").on('change keyup',function(){
        // Vai guardar em password o valor da string introduzida no input pass
        password = $("#userprof").find('input[name="pass"]').val();
    });
    /*********************************************************************************************/
    /****************************     Fim dos Valores a actualizar     ***************************/
    /*********************************************************************************************/
        
    // Obtem o formulario de perfil atraves do seu id (userprof) com jquery
    $("#userprof").submit(function(event) {
                
        // Impede o form de executar a função reset
        event.preventDefault();
        
        // Se o url estiver preenchido usamos o ajax para enviar um request do tipo put para /users
        // Desta forma iremos obter os dados a actualizar em app.js na função app.put('/profile') e os seus
        // valores estarão accessiveis atraves do req.body
        $.ajax({
            url: '/profile',
            data: {
            'profile':{
                'username':username,
                'firstName':firstName,
                'lastName':lastName,
                'email':email,
                'password':password,
                'picurl': picurl
            }},                         // valores que irão para o body -> req.body.profile tera o objecto
                                        // com os valores a actualizar.
                                        
            type: 'PUT',                // Tipo de request a enviar
            cache:false,                // Não guarda em cache os valores para aumentar a performance
            
            // Caso ocorra algum erro iremos executar a função abaixo e obter um log do erro na consola.
            error: function (xhr, status, error) {
                console.log('Error: ' + error.message);
            },
        });
    });
    
    // Obtem o input do tipo reset e altera o seu evento on click
    $("input[type='reset']").on("click",function(event) {
        
        // Impede o form de executar a função reset
        event.preventDefault();
        
        // Obter o elemento que mostra a mensagem que confirma se as passwords sao iguais ou não
        var mensagem = document.getElementById('confirmMessage');
        
        // Obter o elemento que tem o valor da confirmação da password
        var confirmPass = document.getElementById('confirmPass');
        
        // Faz reset a cor do input Confirm Password
        confirmPass.style.backgroundColor = "";
        
        // Faz esconde a mensagem de erro
        mensagem.style.display = 'none';
        
        // Executa a função reset do formulario de perfil para limpar os campos por nos
        $("#userprof")[0].reset();
    });
    
    // Função para verificar se a password é igual a pass de confirmação
    function verificaPass()
    {
        // Obter o elemento que tem o valor da password
        var pass = document.getElementById('pass');
        
        // Obter o elemento que tem o valor da confirmação da password
        var confirmPass = document.getElementById('confirmPass');
        
        // Obter o elemento que ira mostrar a mensagem
        var mensagem = document.getElementById('confirmMessage');
        
        var verde = "#66cc66";
        var vermelho = "#ff6666";
        
        // Compara os valores das passwords quando temos algo escrito nas duas caixas de texto
        if(pass.value.length>0 && confirmPass.value.length>0){
            if(pass.value == confirmPass.value){
            
                // Muda a cor do input confirmPass para verde.
                confirmPass.style.backgroundColor = verde;
                
                // Mostra a mensagem
                mensagem.style.display = 'block';
                
                // com a cor verde
                mensagem.style.color = verde;
                
                // e mensagem a indicar que as passwords sao iguais.
                mensagem.innerHTML = "Passwords são iguais."
                
            }else{
                
                // Muda a cor do input confirmPass para vermelho.
                confirmPass.style.backgroundColor = vermelho;
                
                // Mostra a mensagem
                mensagem.style.display = 'block';
                
                // com a cor verde
                mensagem.style.color = vermelho;
                
                // e mensagem a indicar que as passwords não são iguais.
                mensagem.innerHTML = "Passwords não são iguais! <br/> Verifique onde se enganou..."
            }
        }
    }  